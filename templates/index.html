<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise 360° - Fleuriet & Valuation</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(226, 232, 240, 0.7); border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .form-card { background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.85); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .loading-overlay.active { opacity: 1; visibility: visible; }
        .loading-spinner { width: 60px; height: 60px; border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-item { padding: 0.75rem 1rem; border-radius: 0.75rem; font-weight: 600; color: #4b5563; transition: all 0.3s ease; display: inline-flex; align-items: center; border: 2px solid transparent; cursor: pointer; }
        .tab-item:hover { background-color: #f3f4f6; color: #1f2937; }
        .tab-item.active { background-color: #ffffff; color: #4f46e5; border-color: #4f46e5; box-shadow: 0 4px 14px -2px rgba(79, 70, 229, 0.2); }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .data-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,.05); }
        .enhanced-table { width: 100%; background: white; border-radius: 12px; overflow: hidden; }
        .enhanced-table thead { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; }
        .enhanced-table th, .enhanced-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .enhanced-table tbody tr:last-child td { border-bottom: 0; }
        .sortable:hover { background-color: rgba(255,255,255,0.1); cursor: pointer; }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p class="text-white mt-4 text-lg" id="loadingText">Processando...</p>
    </div>

    <div class="min-h-screen py-8 px-4">
        <div class="container mx-auto max-w-7xl">
            <header class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">Análise 360° de Empresas</h1>
                <p class="text-lg md:text-xl text-gray-600 mt-3">Combine a saúde financeira do Modelo Fleuriet com o potencial de Valuation.</p>
            </header>

            <div class="form-card mb-8">
                <form id="analysisForm" action="/" method="POST" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="md:col-span-2">
                            <label for="cvm_code" class="block text-sm font-semibold text-gray-700 mb-2">Selecione a Empresa</label>
                            <select name="cvm_code" id="cvm_code" required class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition-colors">
                                <option value="" disabled {% if not selected_company %}selected{% endif %}>Escolha uma empresa...</option>
                                {% for company in companies %}
                                    <option value="{{ company.CD_CVM }}" {% if selected_company == company.CD_CVM|string %}selected{% endif %}>
                                        {{ company.TICKER }} - {{ company.NOME_EMPRESA }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="start_year" class="block text-sm font-semibold text-gray-700 mb-2">Ano Início</label>
                            <select name="start_year" id="start_year" required class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none">
                                {% for year in range(2020, 2025) %}<option value="{{ year }}" {% if start_year == year or (not start_year and year == 2020) %}selected{% endif %}>{{ year }}</option>{% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="end_year" class="block text-sm font-semibold text-gray-700 mb-2">Ano Fim</label>
                            <select name="end_year" id="end_year" required class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none">
                                {% for year in range(2020, 2025) %}<option value="{{ year }}" {% if end_year == year or (not end_year and year == 2024) %}selected{% endif %}>{{ year }}</option>{% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <button type="submit" id="submitBtn" class="bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-all duration-200 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                            <span id="btnText">Analisar</span>
                        </button>
                    </div>
                </form>
            </div>

            {% if fleuriet_results %}
                <div id="results-container" class="fade-in space-y-8">
                    <div class="text-center glass-card p-6">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">{{ fleuriet_results.company_name }}</h2>
                        <p class="text-lg text-gray-600">CVM: {{ fleuriet_results.cvm_code }}</p>
                    </div>

                    <div class="bg-white/80 backdrop-blur-sm rounded-lg shadow-md p-2 sticky top-4 z-50">
                        <nav id="analysis-tabs" class="flex justify-center flex-wrap gap-2 sm:gap-4">
                            <button data-tab="fleuriet" class="tab-item active">Saúde Financeira (Fleuriet)</button>
                            <button data-tab="valuation" class="tab-item">Valuation e Ranking</button>
                        </nav>
                    </div>

                    <div id="tab-content">
                        <div id="fleuriet-content" class="tab-pane active">
                            {% include 'partials/_fleuriet_content.html' %}
                        </div>
                        <div id="valuation-content" class="tab-pane">
                            <div id="valuation-placeholder" class="text-center p-8 glass-card">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="text-gray-600 mt-4">Carregando análise de Valuation...</p>
                            </div>
                        </div>
                    </div>
                </div>
            {% elif error %}
                <div class="glass-card p-6 text-center border-2 border-red-200">
                    <h3 class="text-xl font-bold text-red-700">Erro na Análise</h3>
                    <p class="text-red-600 mt-2">{{ error }}</p>
                </div>
            {% endif %}
            
            <footer class="text-center mt-12 pt-6 border-t border-gray-200">
                <p class="text-xs text-gray-500 max-w-4xl mx-auto"><strong>Disclaimer:</strong> As informações apresentadas destinam-se a fins educacionais e não constituem recomendação de investimento.</p>
            </footer>
        </div>
    </div>

    <script>
        // --- ESTADO GLOBAL E VARIÁVEIS ---
        const fleurietResults = JSON.parse('{{ fleuriet_results | tojson | safe if fleuriet_results else 'null' }}');
        const companiesList = JSON.parse('{{ companies | tojson | safe if companies else '[]' }}');
        let valuationData = null;
        let charts = {};
        let currentValuationView = 'overview';
        let currentTicker = '{{ fleuriet_results.ticker if fleuriet_results else '' }}';
        let sortConfig = { key: 'Upside', direction: 'desc' };

        // --- FUNÇÕES DE FORMATAÇÃO ---
        const formatCurrency = (v) => v === null || typeof v === 'undefined' || isNaN(v) ? 'N/D' : `R$ ${v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        const formatPercentage = (v) => v === null || typeof v === 'undefined' || isNaN(v) ? 'N/D' : `${(v * 100).toFixed(2)}%`;
        const getSemanticColor = (v) => v === null || typeof v === 'undefined' || isNaN(v) ? 'text-gray-600' : (v >= 0 ? 'text-green-600' : 'text-red-600');

        // --- LÓGICA DE INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('analysisForm').addEventListener('submit', () => {
                document.getElementById('loadingOverlay').classList.add('active');
                document.getElementById('loadingText').innerText = 'Analisando...';
            });

            if (fleurietResults) {
                setupTabs();
                renderFleurietChart();
                loadAndRenderValuationData();
            }
        });

        // --- CONTROLE DE ABAS ---
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-item');
            const panes = document.querySelectorAll('.tab-pane');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    panes.forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-content').classList.add('active');
                });
            });
        }
        
        // --- RENDERIZAÇÃO DA ABA FLEURIET ---
        function renderFleurietChart() {
            destroyChart('tesouraChart');
            const chartData = fleurietResults?.chart_data;
            const canvas = document.getElementById('tesouraChart');
            if (chartData?.labels?.length > 0 && canvas) {
                const ctx = canvas.getContext('2d');
                charts['tesouraChart'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            { label: 'NCG', data: chartData.ncg, borderColor: '#3b82f6', borderWidth: 3, fill: false, tension: 0.1, pointRadius: 5, pointBackgroundColor: '#3b82f6' },
                            { label: 'CDG', data: chartData.cdg, borderColor: '#10b981', borderWidth: 3, fill: false, tension: 0.1, pointRadius: 5, pointBackgroundColor: '#10b981' },
                            { label: 'Tesouraria', data: chartData.t, borderColor: '#8b5cf6', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.1, pointRadius: 5, pointBackgroundColor: '#8b5cf6' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        // --- RENDERIZAÇÃO DA ABA VALUATION ---
        async function loadAndRenderValuationData() {
            const placeholder = document.getElementById('valuation-placeholder');
            if (valuationData) { renderValuationSubView(); return; }
            
            try {
                const response = await fetch('/get_valuation_data');
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({error: 'Erro desconhecido'}));
                    throw new Error(errorData.error || `Falha na API: ${response.statusText}`);
                }
                valuationData = await response.json();
                renderValuationSubView();
            } catch (error) {
                console.error("Erro ao carregar dados de valuation:", error);
                placeholder.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">${error.message}</div>`;
            }
        }

        function renderValuationSubView() {
            const container = document.getElementById('valuation-content');
            if (!valuationData || valuationData.length === 0) {
                container.innerHTML = `<div class="glass-card p-6 text-center"><p>Nenhum dado de valuation disponível ou que passou nos filtros de sanidade.</p></div>`;
                return;
            }
            
            const nav = `
                <nav id="valuation-navigation" class="flex justify-center items-center border-b border-gray-200 mb-8 bg-white/70 backdrop-blur-sm rounded-lg shadow-sm">
                    <div data-view="overview" class="nav-item">Visão Geral</div>
                    <div data-view="ranking" class="nav-item">Ranking Completo</div>
                    <div data-view="details" class="nav-item">Análise Detalhada</div>
                </nav>
                <div id="valuation-app-content" class="mt-8"></div>
            `;
            container.innerHTML = nav;
            
            document.querySelectorAll('#valuation-navigation .nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === currentValuationView);
                item.addEventListener('click', () => {
                    currentValuationView = item.dataset.view;
                    renderValuationSubView();
                });
            });

            const contentEl = document.getElementById('valuation-app-content');
            const selectedCvm = fleurietResults.cvm_code;
            const companyInfo = companiesList.find(c => c.CD_CVM == selectedCvm);
            currentTicker = companyInfo ? companyInfo.TICKER : null;
            
            switch (currentValuationView) {
                case 'overview': contentEl.innerHTML = getValuationOverviewHTML(valuationData); break;
                case 'ranking': contentEl.innerHTML = getValuationRankingHTML(valuationData); break;
                case 'details': contentEl.innerHTML = getValuationDetailsHTML(valuationData, currentTicker); break;
                default: contentEl.innerHTML = getValuationOverviewHTML(valuationData);
            }
            postRenderValuation(valuationData);
        }

        function postRenderValuation(data) {
            // Adiciona listeners e renderiza gráficos para a view atual do valuation
        }
        
        function getValuationOverviewHTML(data) { /* ... Lógica HTML da Visão Geral do Valuation ... */ return `<div>Conteúdo da Visão Geral do Valuation</div>`; }
        function getValuationRankingHTML(data, searchTerm = '') { /* ... Lógica HTML do Ranking ... */ return `<div>Conteúdo do Ranking do Valuation</div>`; }
        function getValuationDetailsHTML(data, ticker) { /* ... Lógica HTML dos Detalhes ... */ return `<div>Conteúdo dos Detalhes do Valuation</div>`; }
        
        // --- FUNÇÕES UTILITÁRIAS ---
        function destroyChart(id) { if (charts[id]) { charts[id].destroy(); delete charts[id]; } }
    </script>
</body>
</html>
